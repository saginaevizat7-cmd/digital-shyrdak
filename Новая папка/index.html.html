<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Shyrdak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js"></script>
    <style>
        /* Минимальные стили, чтобы было красиво */
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 90vh; background-color: #f7f7f7; }
        #app { max-width: 500px; padding: 30px; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background-color: white; }
        img { width: 100%; border-radius: 5px; }
        button { width: 100%; padding: 12px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        input { width: 80px; padding: 12px; font-size: 16px; margin-right: 10px; text-align: center; }
        #info { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 20px; }
        #feedback { margin-top: 20px; color: gray; font-size: 14px; text-align: center; }
    </style>
</head>
<body>

    <div id="app">
        <h2 style="text-align: center;">Digital Shyrdak: 'Ala-Too'</h2>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Shyrdak_fragment%2C_Kyrgyzstan%2C_Ysyk-K%C3%B6l%2C_mid_20th_century.jpg/1280px-Shyrdak_fragment%2C_Kyrgyzstan%2C_Ysyk-K%C3%B6l%2C_mid_20th_century.jpg" alt="Shyrdak" />
        
        <p style="text-align: center;">Buy a fractional share of this unique masterpiece.</p>

        <button id="connectButton">Connect Wallet</button>
        <p id="account" style="font-size: 12px; text-align: center; word-break: break-all;"></p>
        
        <hr style="margin: 20px 0; border: none; borderTop: '1px solid #eee';">
        
        <div id="info">
            <h3 style="margin: 0 0 10px 0;">Price: 0.01 ETH per share</h3>
            <h3 id="sharesLeft" style="margin: 0; color: #555;">... / 100 shares available</h3>
        </div>
        
        <div style="margin-top: 20px;">
            <input id="buyAmount" type="number" min="1" value="1" />
            <button id="buyButton" disabled>Buy Share(s)</button>
        </div>
        
        <p id="feedback"><i>Status: Connect your wallet to start.</i></p>
    </div>

    <script>
        // ==================================================================
        // Я ВСТАВИЛ ТВОИ ДАННЫЕ СЮДА
        // ==================================================================
        const CONTRACT_ADDRESS = "0x6dfB7F48dA5870FE88150712B75C727cdeeb5AbC"; 

        const contractABI = [
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            }
        ],
        "name": "buyFraction",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "sender",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "balance",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "needed",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "ERC1155InsufficientBalance",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "approver",
                "type": "address"
            }
        ],
        "name": "ERC1155InvalidApprover",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "idsLength",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "valuesLength",
                "type": "uint256"
            }
        ],
        "name": "ERC1155InvalidArrayLength",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            }
        ],
        "name": "ERC1155InvalidOperator",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "receiver",
                "type": "address"
            }
        ],
        "name": "ERC1155InvalidReceiver",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "sender",
                "type": "address"
            }
        ],
        "name": "ERC1155InvalidSender",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "ERC1155MissingApprovalForAll",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "uint256[]",
                "name": "",
                "type": "uint256[]"
            },
            {
                "internalType": "uint256[]",
                "name": "",
                "type": "uint256[]"
            },
            {
                "internalType": "bytes",
                "name": "",
                "type": "bytes"
            }
        ],
        "name": "onERC1155BatchReceived",
        "outputs": [
            {
                "internalType": "bytes4",
                "name": "",
                "type": "bytes4"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            },
            {
                "internalType": "bytes",
                "name": "",
                "type": "bytes"
            }
        ],
        "name": "onERC1155Received",
        "outputs": [
            {
                "internalType": "bytes4",
                "name": "",
                "type": "bytes4"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "OwnableInvalidOwner",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "OwnableUnauthorizedAccount",
        "type": "error"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "bool",
                "name": "approved",
                "type": "bool"
            }
        ],
        "name": "ApprovalForAll",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "previousOwner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "totalFractions",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "pricePerFraction",
                "type": "uint256"
            },
            {
                "internalType": "address",
                "name": "artisanWallet",
                "type": "address"
            },
            {
                "internalType": "string",
                "name": "newTokenURI",
                "type": "string"
            }
        ],
        "name": "registerMasterpiece",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256[]",
                "name": "ids",
                "type": "uint256[]"
            },
            {
                "internalType": "uint256[]",
                "name": "values",
                "type": "uint256[]"
            },
            {
                "internalType": "bytes",
                "name": "data",
                "type": "bytes"
            }
        ],
        "name": "safeBatchTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "id",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "value",
                "type": "uint256"
            },
            {
                "internalType": "bytes",
                "name": "data",
                "type": "bytes"
            }
        ],
        "name": "safeTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "internalType": "bool",
                "name": "approved",
                "type": "bool"
            }
        ],
        "name": "setApprovalForAll",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256[]",
                "name": "ids",
                "type": "uint256[]"
            },
            {
                "indexed": false,
                "internalType": "uint256[]",
                "name": "values",
                "type": "uint256[]"
            }
        ],
        "name": "TransferBatch",
        "type": "event"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "newOwner",
                "type": "address"
            }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "id",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "value",
                "type": "uint256"
            }
        ],
        "name": "TransferSingle",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "string",
                "name": "value",
                "type": "string"
            },
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "id",
                "type": "uint256"
            }
        ],
        "name": "URI",
        "type": "event"
    },
    {
        "inputs": [],
        "name": "withdrawETH",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "id",
                "type": "uint256"
            }
        ],
        "name": "balanceOf",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address[]",
                "name": "accounts",
                "type": "address[]"
            },
            {
                "internalType": "uint256[]",
                "name": "ids",
                "type": "uint256[]"
            }
        ],
        "name": "balanceOfBatch",
        "outputs": [
            {
                "internalType": "uint256[]",
                "name": "",
                "type": "uint256[]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "getFractionsAvailable",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            }
        ],
        "name": "isApprovedForAll",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "masterpieces",
        "outputs": [
            {
                "internalType": "address",
                "name": "artisanWallet",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "pricePerFraction",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "totalFractions",
                "type": "uint256"
            },
            {
                "internalType": "bool",
                "name": "exists",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes4",
                "name": "interfaceId",
                "type": "bytes4"
            }
        ],
        "name": "supportsInterface",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "tokenURIs",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "uri",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];
        // ==================================================================
        // ДАЛЬШЕ НИЧЕГО НЕ ТРОГАЙ
        // ==================================================================


        // --- ИНФО ДЛЯ ДЕМО (захардкожено) ---
        const DEMO_TOKEN_ID = 1;
        const DEMO_TOTAL_SHARES = 100;
        const DEMO_PRICE_ETH = "0.01";

        // --- Переменные для работы ---
        let provider;
        let signer;
        let contract;

        // --- Связываем элементы HTML с JavaScript ---
        const connectButton = document.getElementById('connectButton');
        const buyButton = document.getElementById('buyButton');
        const buyAmountInput = document.getElementById('buyAmount');
        const accountLabel = document.getElementById('account');
        const sharesLeftLabel = document.getElementById('sharesLeft');
        const feedbackLabel = document.getElementById('feedback');

        // --- Логика ---

        // 1. Подключение кошелька
        connectButton.addEventListener('click', async () => {
            if (!window.ethereum) {
                setFeedback("Please install MetaMask!");
                return;
            }
            try {
                setFeedback("Connecting...");
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                const account = await signer.getAddress();
                
                accountLabel.innerHTML = `Connected: <b>${account}</b>`;
                connectButton.style.display = 'none'; // Прячем кнопку
                buyButton.disabled = false; // Открываем кнопку "Купить"

                // Создаем "связь" с контрактом
                contract = new ethers.Contract(CONTRACT_ADDRESS, contractABI, provider);
                
                await fetchSharesLeft(); // Загружаем данные
            } catch (err) {
                console.error(err);
                setFeedback("Failed to connect wallet.");
            }
        });

        // 2. Получение данных с контракта
        async function fetchSharesLeft() {
            if (!contract) return;
            setFeedback("Fetching available shares...");
            try {
                const available = await contract.getFractionsAvailable(DEMO_TOKEN_ID);
                sharesLeftLabel.innerText = `${Number(available)} / ${DEMO_TOTAL_SHARES} shares available`;
                setFeedback("Data loaded. Ready to buy.");
            } catch (err) {
                console.error(err);
                setFeedback("Could not fetch data from contract.");
            }
        }

        // 3. Покупка долей
        buyButton.addEventListener('click', async () => {
            if (!signer) return;
            
            const buyAmount = buyAmountInput.value;
            if (buyAmount <= 0) {
                setFeedback("Amount must be > 0");
                return;
            }

            try {
                setFeedback("Preparing transaction...");
                const contractWithSigner = contract.connect(signer);
                
                const pricePerFractionWei = ethers.parseEther(DEMO_PRICE_ETH);
                const totalPriceWei = pricePerFractionWei * BigInt(buyAmount);

                const tx = await contractWithSigner.buyFraction(DEMO_TOKEN_ID, buyAmount, {
                    value: totalPriceWei
                });

                setFeedback("Transaction sent! Waiting for confirmation...");
                buyButton.disabled = true; // Блокируем кнопку на время
                await tx.wait();

                setFeedback(`Success! You bought ${buyAmount} share(s).`);
                await fetchSharesLeft(); // Обновляем данные
                buyButton.disabled = false; // Разблокируем кнопку
                
            } catch (err) {
                console.error(err);
                setFeedback(err.reason || err.message || "Transaction failed.");
                buyButton.disabled = false;
            }
        });

        function setFeedback(message) {
            feedbackLabel.innerHTML = `<i>Status: ${message}</i>`;
        }

    </script>
</body>
</html>